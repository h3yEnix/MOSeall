!function(c){c.widget("ui.nestedSortable",c.extend({},c.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",listType:"ol",maxLevels:0,noJumpFix:0},_create:function(){return 0==this.noJumpFix&&this.element.height(this.element.height()),this.element.data("sortable",this.element.data("nestedSortable")),c.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(t){var e,i;this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(e=this.options,i=!1,this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<e.scrollSensitivity?this.scrollParent[0].scrollTop=i=this.scrollParent[0].scrollTop+e.scrollSpeed:t.pageY-this.overflowOffset.top<e.scrollSensitivity&&(this.scrollParent[0].scrollTop=i=this.scrollParent[0].scrollTop-e.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<e.scrollSensitivity?this.scrollParent[0].scrollLeft=i=this.scrollParent[0].scrollLeft+e.scrollSpeed:t.pageX-this.overflowOffset.left<e.scrollSensitivity&&(this.scrollParent[0].scrollLeft=i=this.scrollParent[0].scrollLeft-e.scrollSpeed)):(t.pageY-c(document).scrollTop()<e.scrollSensitivity?i=c(document).scrollTop(c(document).scrollTop()-e.scrollSpeed):c(window).height()-(t.pageY-c(document).scrollTop())<e.scrollSensitivity&&(i=c(document).scrollTop(c(document).scrollTop()+e.scrollSpeed)),t.pageX-c(document).scrollLeft()<e.scrollSensitivity?i=c(document).scrollLeft(c(document).scrollLeft()-e.scrollSpeed):c(window).width()-(t.pageX-c(document).scrollLeft())<e.scrollSensitivity&&(i=c(document).scrollLeft(c(document).scrollLeft()+e.scrollSpeed))),!1!==i&&c.ui.ddmanager&&!e.dropBehaviour&&c.ui.ddmanager.prepareOffsets(this,t)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var s=this.items.length-1;0<=s;s--){var o=this.items[s],l=o.item[0],r=this._intersectsWithPointer(o);if(r&&!(l==this.currentItem[0]||this.placeholder[1==r?"next":"prev"]()[0]==l||c.contains(this.placeholder[0],l)||"semi-dynamic"==this.options.type&&c.contains(this.element[0],l))){if(this.direction=1==r?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(o))break;this._rearrange(t,o),this._clearEmpty(l),this._trigger("change",t,this._uiHash());break}}var n=this.placeholder[0].parentNode.parentNode&&c(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?c(this.placeholder[0].parentNode.parentNode):null,h=this._getLevel(this.placeholder),a=this._getChildLevels(this.helper),p=this.placeholder[0].previousSibling?c(this.placeholder[0].previousSibling):null;if(null!=p)for(;"li"!=p[0].nodeName.toLowerCase()||p[0]==this.currentItem[0];){if(!p[0].previousSibling){p=null;break}p=c(p[0].previousSibling)}return newList=document.createElement(e.listType),this.beyondMaxLevels=0,null!=n&&this.positionAbs.left<n.offset().left?(n.after(this.placeholder[0]),this._clearEmpty(n[0]),this._trigger("change",t,this._uiHash())):null!=p&&this.positionAbs.left>p.offset().left+e.tabSize?(this._isAllowed(p,h+a+1),p.children(e.listType).length||p[0].appendChild(newList),p.children(e.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",t,this._uiHash())):this._isAllowed(n,h+a),this._contactContainers(t),c.ui.ddmanager&&c.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t,e){if(this.beyondMaxLevels){for(var i=this.placeholder.parent().closest(this.options.items),s=this.beyondMaxLevels-1;0<s;s--)i=i.parent().closest(this.options.items);this.placeholder.removeClass(this.options.errorClass),i.after(this.placeholder),this._trigger("change",t,this._uiHash())}c.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(i){var t=this._getItemsAsjQuery(i&&i.connected),s=[];return i=i||{},c(t).each(function(){var t=(c(i.item||this).attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/),e=(c(i.item||this).parent(i.listType).parent("li").attr(i.attribute||"id")||"").match(i.expression||/(.+)[-=_](.+)/);t&&s.push((i.key||t[1]+"["+(i.key&&i.expression?t[1]:t[2])+"]")+"="+(e?i.key&&i.expression?e[1]:e[2]:"root"))}),!s.length&&i.key&&s.push(i.key+"="),s.join("&")},toHierarchy:function(o){o=o||{};var e=[];return c(this.element).children("li").each(function(){var t=function e(t){var i=(c(t).attr(o.attribute||"id")||"").match(o.expression||/(.+)[-=_](.+)/);if(null!=i){var s={id:i[2]};return 0<c(t).children(o.listType).children("li").length&&(s.children=[],c(t).children(o.listType).children("li").each(function(){var t=e(c(this));s.children.push(t)})),s}}(c(this));e.push(t)}),e},toArray:function(o){var l=(o=o||{}).startDepthCount||0,r=[],t=2;return r.push({item_id:"root",parent_id:"none",depth:l,left:"1",right:2*(c("li",this.element).length+1)}),c(this.element).children("li").each(function(){t=function t(e,i,s){right=s+1;0<c(e).children(o.listType).children("li").length&&(i++,c(e).children(o.listType).children("li").each(function(){right=t(c(this),i,right)}),i--);id=c(e).attr(o.attribute||"id").match(o.expression||/(.+)[-=_](.+)/);pid=i===l+1?"root":(parentItem=c(e).parent(o.listType).parent("li").attr("id").match(o.expression||/(.+)[-=_](.+)/),parentItem[2]);null!=id&&r.push({item_id:id[2],parent_id:pid,depth:i,left:s,right:right});return s=right+1}(this,l+1,t)}),r=r.sort(function(t,e){return t.left-e.left})},_clear:function(t,e){c.ui.sortable.prototype._clear.apply(this,arguments);for(var i=this.items.length-1;0<=i;i--){var s=this.items[i].item[0];this._clearEmpty(s)}return!0},_clearEmpty:function(t){t.children[1]&&0==t.children[1].children.length&&t.removeChild(t.children[1])},_getLevel:function(t){var e=1;if(this.options.listType)for(var i=t.closest(this.options.listType);!i.is(".ui-sortable");)e++,i=i.parent().closest(this.options.listType);return e},_getChildLevels:function(t,i){var s=this,e=this.options,o=0;return i=i||0,c(t).children(e.listType).children(e.items).each(function(t,e){o=Math.max(s._getChildLevels(e,i+1),o)}),i?o+1:o},_isAllowed:function(t,e){var i=this.options;null!=t&&t.hasClass(i.disableNesting)?(this.placeholder.addClass(i.errorClass),i.maxLevels<e&&0!=i.maxLevels?this.beyondMaxLevels=e-i.maxLevels:this.beyondMaxLevels=1):i.maxLevels<e&&0!=i.maxLevels?(this.placeholder.addClass(i.errorClass),this.beyondMaxLevels=e-i.maxLevels):(this.placeholder.removeClass(i.errorClass),this.beyondMaxLevels=0)}})),c.ui.nestedSortable.prototype.options=c.extend({},c.ui.sortable.prototype.options,c.ui.nestedSortable.prototype.options)}(jQuery);